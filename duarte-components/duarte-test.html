<link rel="import" href="../components/core-ajax/core-ajax.html">
<link rel="import" href="../components/paper-input/paper-input.html">
<link rel="import" href="../components/paper-button/paper-button.html">

<link rel="import" href="../library-components/pushstate-anchor/pushstate-anchor.html">

<link rel="import" href="../duarte-components/duarte-map.html">

<script type="text/javascript" src="http://192.168.0.189:8080/socket.io/socket.io.js"></script>

<polymer-element name="duarte-test">
	<template>
	<style type="text/css">

		paper-button {
			background: #2196F3;
			color: white;
		}

		.map {
			float: left;
		}

		.map {
			margin-left: 10px;
		}

		duarte-map {
			width: 200px;
			height: 200px;
			display: inline-block;
		}

	</style>

		<core-ajax
			id="get"
			auto="true"
			method="get"
			url="http://192.168.0.189:8080/level/all"
			on-core-response="{{onGetResponse}}"
			contentType="application/json"
			withCredentials="true"
			></core-ajax>

		<core-ajax
			id="submit"
			method="post"
			url="http://192.168.0.189:8080/level/submit"
			on-core-response="{{onSubmitResponse}}"
			contentType="application/json"
			withCredentials="true"
			></core-ajax>

		<core-ajax
			id="remove"
			method="delete"
			url="http://192.168.0.189:8080/level/byid"
			on-core-response="{{onRemoveResponse}}"
			contentType="application/json"
			withCredentials="true"
			></core-ajax>

		<paper-button raised on-tap="{{randomize}}">Randomize</paper-button>
		<paper-button raised on-tap="{{submit}}">Submit</paper-button>

		<paper-input floatingLabel label="Title" value="{{title}}"></paper-input>
		<duarte-map grid="{{grid}}"></duarte-map>

		<div>
			<h1>Levels</h1>
			<template repeat="{{level in levels}}">
				<div class="map">
					{{level.title}} by {{level.creator.username}} <paper-button raised data-id="{{level._id}}" on-tap="{{remove}}">Remove</paper-button>
					<div><duarte-map grid="{{level.grid}}"></duarte-map></div>
				</div>
				
			</template>	
		</div>
	</template>
	<script>
	(function() {'use strict';

		Polymer('duarte-test', {
			title: 'En bana.',
			gridWidth: 30,
			gridHeight: 25,
			gridSize: 30 * 25,
			ready: function() {
				this.randomize();
			},
			onRouteEnter: function() {
				this._onNewLevel = this.onNewLevel.bind(this);
				this._onRemoveLevel = this.onRemoveLevel.bind(this);
				this.socket.on('level added', this._onNewLevel);
				this.socket.on('level removed', this._onRemoveLevel);
			},
			onRouteLeave: function() {
				this.socket.off('level added', this._onNewLevel);
			},
			onNewLevel: function(level) {
				this.levels.push(level);
				console.log(level);
			},
			onRemoveLevel: function(id) {
				for(var i = 0, l = this.levels.length; i < l; i++) {
					var level = this.levels[i];
					if(level._id === id) {
						this.levels.splice(this.levels.indexOf(level), 1);
						break;
					}
				}
			},
			onGetResponse: function(e, detail) {
				this.levels = JSON.parse(detail.response);
				console.log(this.levels);
			},
			onSubmitResponse: function(e, detail) {
				var response = JSON.parse(detail.response);
				console.log(response);
				if(!response.message) {
					this.grid = response.grid;
				}
			},
			onRemoveResponse: function(e, detail) {
				var response = JSON.parse(detail.response);
				console.log(response);
			},
			randomize: function() {
				var grid = new Array(this.gridSize);
				for(var i = 0; i < this.gridSize; i++) {
					grid[i] = Math.random() < 0.99 ? 0 : 1;
				}
				this.grid = grid;
			},
			submit: function() {
				var submit = this.$.submit;
				
				
				submit.body = JSON.stringify({
					title: this.title,
					grid: this.grid
				});

				submit.go();
			},
			remove: function(e, detail, button) {
				var remove = this.$.remove;
				remove.body = JSON.stringify({id: button.dataset.id});
				remove.go();
			}
		});
	})();
	</script>
</polymer-element>