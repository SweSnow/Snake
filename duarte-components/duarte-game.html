<link rel="import" href="../components/core-ajax/core-ajax.html">
<link rel="import" href="../components/paper-button/paper-button.html">
<link rel="import" href="../components/core-icons/av-icons.html">
<link rel="import" href="../components/paper-button/paper-button.html">

<link rel="import" href="../duarte-components/duarte-map.html">
<link rel="import" href="../duarte-components/duarte-rate.html">

<script type="text/javascript" src="../js/jquery.js"></script>
<script type="text/javascript" src="../js/gameoptions.js"></script>
<script type="text/javascript" src="../js/level.js"></script>
<script type="text/javascript" src="../js/levelcreator.js"></script>
<script type="text/javascript" src="../js/game.js"></script>
<script type="text/javascript" src="../js/gamecreator.js"></script>
<script type="text/javascript" src="../js/entities.js"></script>
<script type="text/javascript" src="../js/keyboard.js"></script>

<polymer-element name="duarte-game" attributes="levelId">
	<template>

	<style type="text/css">

		:host {
			display: block;
			position: relative;
			width: 600px;
			height: 600px;
			margin-bottom: 48px;
			margin-top: 42px;
			margin-left: auto;
			margin-right: auto;
			padding: 0;
		}

		.g_food {
			position: absolute;
			background-color: #4CAF50;
			z-index: 1;
		}

		.g_obstacle {
			position: absolute;
			background-color: #444;
			z-index: 1;
		}

		.g_bug {
			position: absolute;
			background-color: #03A9F4;
			z-index: 1;
		}

		.g_player {
			transition: all 50ms;
			position: absolute;
			z-index: 2;
		}

		.g_tail {
			position: absolute;
			z-index: 1;
		}

		.g_pointer {
			outline: #009688 1px dotted;
			position: absolute;
			z-index: 1;
		}

		.game-ripple {
			position: absolute;
			display: block;
			top: 100px;
			left: 0;
			width: 600px;
			height: 500px;
			z-index: 3;
		}

		#foodRipple {
			color: #4CAF50;
		}

		#bugRipple {
			color: #03A9F4;
		}

		#container {
			position: relative;
			background: #ffffff;
			display: block;
			width: 600px;
			height: 600px;
		}

		#htmlCanvas {
			position: absolute;
			display: block;
			top: 100px;
			left: 0;
			width: 600px;
			height: 500px;
		}

		#gameOverlay {
			position: absolute;
			box-sizing: border-box;
			padding: 16px;
			color: #fff;
			background: #009688;
			width: 600px;
			height: 100px;
		}

		#timeAttackText {
			display: block;
			float: right;
		}

		#scoreText {
			display: block;
			float: left;
			font-size: 25px;
		}

		#pauseResume {
			display: block;
			float: right;
		}

		#gameOverOverlay {
			color: #fff;
			background-color: #009688;
			box-sizing: border-box;
			padding: 16px;
			position: absolute;
			z-index: 4;
			left: 150px;
			width: 300px;
			height: 154px;
			top: 245px; 
		}

		#label {
			font-weight: 500;
			font-size: 23px;
		}

		#gameOverOverlay paper-button {
			float: right;
			margin-top: 12px;
			margin-right: -7px;
		}

		#gameOverScore {
			padding-top: 6px;
			font-size: 16px;
		}

		#gameOverMessage {
			padding-top: 6px;
			font-size: 16px;
		}

		#quit {
			color: #fff;
		}

		#rate {
			float: right;
		}

		#exit {
			float: right;
		}

		#exitCreateLink {
			color: #fff;
		}

		#rate-container {
			box-sizing: border-box;
			position: absolute;
			width: 400px;
			left: 100px;
			top: 200px;
			background-color: #fff;
			padding-left: 20px;
			padding-right: 20px;
			z-index: 5;
		}


	</style>

	<div id="container">

		<paper-shadow z="2" id="gameOverlay">
				
			<div id="timeAttackText"></div>
			<div id="scoreText"></div>

			<div hidden?="{{mode === 'create'}}" >
				<paper-button on-tap="{{pauseResume}}" hidden?="{{gameOver}}" raised id="pauseResume">
					<core-icon hidden?="{{!isPlaying}}" icon="av:pause"></core-icon>
					<core-icon hidden?="{{isPlaying}}" icon="av:play-arrow"></core-icon>
				</paper-button>

				<paper-button on-tap="{{rate}}" id="rate"  raised>Rate</paper-button>
			</div>

			<div hidden?="{{mode === 'normal'}}" >

				<a id="exitCreateLink" is="pushstate-anchor" href="/profile">
					<paper-button on-tap="{{exitCreate}}" id="exit" raised>Save and Exit</paper-button>
				</a>
				

				<paper-input floatingLabel label="Map name" value="{{mapname}}"></paper-input>
			</div>

		</paper-shadow>

		<paper-ripple class="game-ripple" id="foodRipple" style="pointer-events: none;"></paper-ripple>
		<paper-ripple class="game-ripple" id="bugRipple" style="pointer-events: none;"></paper-ripple>
			
		<paper-shadow z="2" id="htmlCanvas">
			
		</paper-shadow>

		<paper-shadow id="rate-container" z="1" hidden?="{{!rating}}">
			<duarte-rate levelId="{{levelId}}"></duarte-rate>
		</paper-shadow>

		<paper-shadow z="3" id="gameOverOverlay" hidden?="{{!gameOver}}">

			<div id="label">Game Over!</div>
			<div id="gameOverMessage">{{message}}</div>
			<div id="gameOverScore">Score: 100 Points</div>

			<paper-button on-tap="{{retry}}">Retry</paper-button>
			<a is="pushstate-anchor" href="/browse">
				<paper-button id="quit">Back to browse</paper-button>
			</a>

		</paper-shadow>
		
	</div>

	<core-ajax
		id="request"
		method="get"
		url="http://78.68.39.230:8080/level/byid?id={{levelId}}"
		on-core-response="{{onResponse}}"
		contentType="application/json"
		withCredentials="true"
		></core-ajax>
		
	</template>
	<script>
	(function() {

	Polymer('duarte-game', {
		mode: false,
		ready: function() {
			
		},
		onResponse: function(e, detail) {
			var level = JSON.parse(detail.response);
			this.startGame(level.grid);
		},
		startGame: function(grid) {

			if (this.isPlaying) {
				return;
			}

			timeAttackTimeElement = $(this.$.timeAttackText);
			scoreTextElement = $(this.$.scoreText);
			gameOverOverlay = $(this.$.gameOverOverlay);
			gameOverScore = $(this.$.gameOverScore);
			foodRipple = $(this.$.foodRipple);
			bugRipple = $(this.$.bugRipple);
			htmlCanvas = $(this.$.htmlCanvas);

			this.isPlaying = true;

			if (this.mode === 'normal') {
				this.game = new Game(htmlCanvas, this.mode, grid, this);
			} else if (this.mode === 'create') {
				this.game = new GameCreator(htmlCanvas, this.mode, grid, this);
			}

			this.game.gameStateChanged = this.onGameStateChanged.bind(this);
			this.game.onGameState = this.onGameState.bind(this);
		},
		onRouteEnter: function() {
			if (this.path == '/play') {
				this.mode = 'normal';
			} else if (this.path = '/create') {
				this.mode = 'create';
			}

			if(this.levelId) {
				this.$.request.go();
			} else {
				this.startGame(new Level.createDefaultLevel(600, 500, 20));
			}
		},
		onRouteLeave: function() {
			// state = this.game.saveState();
		},
		retry: function() {
			gameOver = false;
			isPlaying = true;

			if(this.levelId) {
				this.$.request.go();
			} else {
				this.startGame(new Level.createDefaultLevel(600, 500, 20));
			}
		},
		end: function(message) {
			this.gameOver = true;
			this.isPlaying = false;
			this.message = message;
		},
		pauseResume: function() {
			this.isPlaying = !this.isPlaying;
			if (this.isPlaying) {
				this.game.resume();
			} else {
				this.game.pause();
			}
		},
		rate: function() {
			this.rating = true;
		},
		onGameState: function(state) {

		},
		onGameStateChanged: function(state) {
			if (state == 'over') {
				gameOver = true;
			} else {
				gameOver = false;
			}
		},
		exitCreate: function() {

		},
		gameOver: false,
		gameMode: 'normal',
		isPlaying: false,
		rating: false,
		mode: 'normal'

	});

	})();

  </script>
</polymer-element>